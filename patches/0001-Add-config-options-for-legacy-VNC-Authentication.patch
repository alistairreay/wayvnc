From 37b6c8f9e0ded0b7447c7171705f10a3b4809c98 Mon Sep 17 00:00:00 2001
From: Alistair Reay <5599065+alistairreay@users.noreply.github.com>
Date: Fri, 20 Feb 2026 15:43:46 +0000
Subject: [PATCH] Add config options for legacy VNC Authentication
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Wire up neatvnc's new VNC Auth (type 2) support with config options:
- enable_vnc_auth: opt-in toggle for legacy DES challenge-response auth
- vnc_password: separate password for VNC Auth (distinct from VeNCrypt)

Logs a warning when legacy auth is enabled. Both auth types can be
offered simultaneously â€” the client chooses which it supports.
---
 include/cfg.h |  2 ++
 src/main.c    | 21 ++++++++++++++++++++-
 wayvnc.scd    | 15 +++++++++++++++
 3 files changed, 37 insertions(+), 1 deletion(-)

diff --git a/include/cfg.h b/include/cfg.h
index 68ebaa7..efbb041 100644
--- a/include/cfg.h
+++ b/include/cfg.h
@@ -35,6 +35,8 @@
 	X(string, xkb_layout) \
 	X(string, xkb_variant) \
 	X(string, xkb_options) \
+	X(bool, enable_vnc_auth) \
+	X(string, vnc_password) \
 	X(bool, use_relative_paths) \
 
 struct cfg {
diff --git a/src/main.c b/src/main.c
index 30e40e4..df0cb92 100644
--- a/src/main.c
+++ b/src/main.c
@@ -708,6 +708,9 @@ bool on_auth(const char* username, const char* password, void* ud)
 		return pam_auth(username, password);
 #endif
 
+	if (!self->cfg.username || !self->cfg.password)
+		return false;
+
 	if (strcmp(username, self->cfg.username) != 0)
 		return false;
 
@@ -1087,7 +1090,23 @@ static int init_nvnc(struct wayvnc* self)
 		auth_flags |= NVNC_AUTH_REQUIRE_ENCRYPTION;
 	}
 
-	if (self->cfg.enable_auth) {
+	if (self->cfg.enable_vnc_auth && self->cfg.vnc_password) {
+		nvnc_log(NVNC_LOG_WARNING,
+			"VNC Authentication (type 2) enabled. "
+			"This is a legacy auth method with weak security. "
+			"Use only for compatibility with clients like macOS Screen Sharing.");
+		if (nvnc_set_vnc_auth_password(self->nvnc, self->cfg.vnc_password) < 0) {
+			nvnc_log(NVNC_LOG_ERROR, "Failed to set VNC auth password");
+			goto auth_failure;
+		}
+		/* VNC Auth requires NVNC_AUTH_REQUIRE_AUTH to be offered,
+		 * and encryption cannot be required since VNC Auth is
+		 * unencrypted by design. */
+		auth_flags |= NVNC_AUTH_REQUIRE_AUTH;
+		auth_flags &= ~NVNC_AUTH_REQUIRE_ENCRYPTION;
+	}
+
+	if (self->cfg.enable_auth || self->cfg.enable_vnc_auth) {
 		if (nvnc_enable_auth(self->nvnc, auth_flags, on_auth, self) < 0) {
 			nvnc_log(NVNC_LOG_ERROR, "Failed to enable authentication");
 			goto auth_failure;
diff --git a/wayvnc.scd b/wayvnc.scd
index 781c28c..640f73b 100644
--- a/wayvnc.scd
+++ b/wayvnc.scd
@@ -145,6 +145,14 @@ considered to be part of the key or the value.
 	The path to the private key file for TLS encryption. Only applicable
 	when *enable_auth*=true.
 
+*enable_vnc_auth*
+	Enable legacy VNC Authentication (RFB security type 2). This is a
+	password-only DES challenge-response scheme with no encryption. It is
+	required for compatibility with macOS Screen Sharing and other clients
+	that do not support VeNCrypt or RSA-AES. Requires *vnc_password* to be
+	set. Can be used alongside *enable_auth* to offer both modern and legacy
+	auth types simultaneously.
+
 *relax_encryption*
 	Don't require encryption after the user has been authenticated. This
 	enables some security types such as Apple Diffie-Hellman.
@@ -156,6 +164,11 @@ considered to be part of the key or the value.
 *username*
 	Choose a username for authentication.
 
+*vnc_password*
+	The password for legacy VNC Authentication (type 2). Only the first 8
+	characters are used (VNC protocol limitation). Only applicable when
+	*enable_vnc_auth*=true.
+
 *use_relative_paths*
 	Make file paths relative to the location of the config file.
 
@@ -197,6 +210,8 @@ password=p455w0rd
 rsa_private_key_file=rsa_key.pem
 private_key_file=tls_key.pem
 certificate_file=tls_cert.pem
+enable_vnc_auth=true
+vnc_password=secret
 ```
 
 # WAYVNCCTL CONTROL SOCKET
-- 
2.53.0

